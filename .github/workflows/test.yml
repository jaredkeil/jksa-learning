name: CI

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: 'Create env file'
      run: echo "${{ secrets.ENV_FILE }}" > .env.test

    - name: Build Docker image
      run: docker compose --env-file=.env.test build

    - name: Start services
      run: docker-compose up -d

    - name: Wait for backend service availability
      run: dockerize -wait http://web:8000 -timeout 60s

    - name: Run pytest
      run: docker compose --env-file=.env.test exec web poetry run ./scripts/run_pytest.sh
